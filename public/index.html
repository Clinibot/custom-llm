<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA al Teléfono | Constructor de Agentes</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/neo.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/markdown/markdown.min.js"></script>
</head>

<body>
    <div class="layout">
        <!-- Sidebar - Agent List -->
        <aside>
            <div class="sidebar-header">
                <div class="brand">IA AL TELÉFONO</div>
                <div class="agent-list-header">
                    <span>Mis Agentes</span>
                    <button id="newAgentBtn" class="btn-icon" title="Nuevo Agente">+</button>
                </div>
            </div>
            <nav id="agentList">
                <div class="status">Cargando agentes...</div>
            </nav>
            <div class="sidebar-footer">
                <button id="saveBtn">GUARDAR CAMBIOS</button>
                <div id="status" class="status"></div>
            </div>
        </aside>

        <!-- Main Editor (Prompt) -->
        <main id="editorArea" class="editor-pane hidden">
            <header class="agent-header">
                <div class="section-label">Nombre del Agente</div>
                <input type="text" id="agentName" class="input-large" placeholder="Escribe un nombre...">
                <div id="agentMetadata" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"></div>
            </header>

            <section>
                <div class="section-label">System Prompt</div>
                <div class="editor-container">
                    <textarea id="systemPrompt"></textarea>
                </div>
            </section>

            <section>
                <div class="section-label">Saludo Inicial</div>
                <input type="text" id="greeting" placeholder="Hola, ¿cómo puedo ayudarte?">
            </section>
        </main>

        <!-- Settings Pane (Right) -->
        <div id="settingsArea" class="settings-pane hidden">
            <div class="field">
                <label>Proveedor (Brain)</label>
                <select id="provider" onchange="updateProviderUI()">
                    <option value="openai">OpenAI (GPT)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="deepseek">DeepSeek (Potente/Económico)</option>
                </select>
            </div>

            <!-- API Keys -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('api-content', this)">
                    <h3>API Keys (Multi-User)</h3>
                    <svg class="chevron rotated" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="api-content" class="card-content accordion-content active">
                    <div id="openaiKeyField" class="field">
                        <label>OpenAI API Key</label>
                        <input type="password" id="openaiApiKey" placeholder="sk-...">
                    </div>
                    <div id="anthropicKeyField" class="field hidden">
                        <label>Anthropic API Key</label>
                        <input type="password" id="anthropicApiKey" placeholder="sk-ant-...">
                    </div>
                    <div id="deepseekKeyField" class="field hidden">
                        <label>DeepSeek API Key</label>
                        <input type="password" id="deepseekApiKey" placeholder="sk-...">
                        <p class="field-desc">DeepSeek usa el mismo protocolo que OpenAI.</p>
                    </div>
                    <div class="field">
                        <label>Retell API Key</label>
                        <input type="password" id="retellApiKey" placeholder="Su Retell Key">
                    </div>
                </div>
            </div>

            <!-- Integration -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('retell-content', this)">
                    <h3>Retell AI Integration</h3>
                    <svg class="chevron rotated" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="retell-content" class="card-content accordion-content active">
                    <div class="field">
                        <label>Custom LLM URL</label>
                        <div class="url-copy-wrapper">
                            <input type="text" id="retellUrl" readonly>
                            <button class="btn-secondary" onclick="copyUrl()">COPIAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Parameters -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('model-content', this)">
                    <h3>Modelo y Parámetros</h3>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="model-content" class="card-content accordion-content">
                    <div class="row">
                        <div class="field">
                            <label>Modelo</label>
                            <select id="model">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="field">
                            <label>Idioma</label>
                            <select id="language">
                                <option value="Spanish">Español</option>
                                <option value="English">Inglés</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Temp</label>
                            <input type="number" id="temperature" step="0.1" value="0.8">
                        </div>
                        <div class="field">
                            <label>Max Tokens</label>
                            <input type="number" id="maxTokens" value="400">
                        </div>
                    </div>
                    <div class="field">
                        <label>Texto recordatorio (silencio)</label>
                        <input type="text" id="reminderText">
                    </div>
                </div>
            </div>

            <button class="btn-danger" id="deleteBtn">ELIMINAR AGENTE</button>
        </div>
    </div>

    <!-- Empty State -->
    <main id="emptyArea" class="empty-pane">
        <div class="brand" style="font-size: 3.5rem; margin-bottom: 2rem;">IA AL TELÉFONO</div>
        <p style="color: var(--text-muted); margin-bottom: 32px; font-size: 1.1rem;">Selecciona un agente de la lista o
            crea uno nuevo para empezar.</p>
        <button onclick="createNewAgent()"
            style="width: auto; padding: 14px 28px; background: var(--text-main); color: white; border: none; font-weight: 600;">+
            CREAR NUEVO AGENTE</button>
    </main>

    <script>
        let editor;
        let currentAgentId = null;
        let agents = [];

        window.addEventListener('DOMContentLoaded', () => {
            editor = CodeMirror.fromTextArea(document.getElementById('systemPrompt'), {
                mode: 'markdown',
                theme: 'neo',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: Infinity
            });
            loadAgentList();
        });

        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            const chevron = header.querySelector('.chevron');
            if (content.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => { content.classList.remove('active'); content.style.maxHeight = '0'; }, 10);
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('active');
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => { content.style.maxHeight = 'none'; }, 300);
                chevron.classList.add('rotated');
            }
        }

        async function loadAgentList() {
            try {
                const res = await fetch('/api/agents');
                agents = await res.json();
                renderAgentList();
            } catch (err) {
                showStatus('ERROR AL CARGAR LISTA', 'error');
            }
        }

        function renderAgentList() {
            const list = document.getElementById('agentList');
            list.innerHTML = '';
            if (agents.length === 0) {
                list.innerHTML = '<div class="status">No hay agentes.</div>';
                return;
            }
            agents.forEach(agent => {
                const div = document.createElement('div');
                div.className = `nav-item ${currentAgentId === agent.id ? 'active' : ''}`;
                div.textContent = agent.name;
                div.onclick = () => loadAgent(agent.id);
                list.appendChild(div);
            });
        }

        async function loadAgent(id) {
            currentAgentId = id;
            try {
                const res = await fetch(`/api/agents/${id}`);
                const agent = await res.json();

                document.getElementById('agentName').value = agent.name;
                editor.setValue(agent.system_prompt || '');
                document.getElementById('greeting').value = agent.greeting || '';
                document.getElementById('provider').value = agent.provider || 'openai';
                updateProviderUI(); // Important to refresh model list and keys
                document.getElementById('model').value = agent.model || (agent.provider === 'anthropic' ? 'claude-3-5-haiku-latest' : 'gpt-4.1-mini');
                document.getElementById('temperature').value = agent.temperature ?? 0.8;
                document.getElementById('maxTokens').value = agent.max_tokens || 400;
                document.getElementById('reminderText').value = agent.reminder_text || '';
                document.getElementById('language').value = agent.language || 'Spanish';
                document.getElementById('openaiApiKey').value = agent.openai_api_key || '';
                document.getElementById('anthropicApiKey').value = agent.anthropic_api_key || '';
                // DeepSeek uses openaiApiKey slot/logic for simplicity in this proto, or we can map it
                if (agent.provider === 'deepseek') document.getElementById('deepseekApiKey').value = agent.openai_api_key || '';

                document.getElementById('retellApiKey').value = agent.retell_api_key || '';

                const wsBase = window.location.origin.replace('http', 'ws');
                document.getElementById('retellUrl').value = `${wsBase}/llm-websocket/{{call_id}}?agent_id=${agent.id}`;

                document.getElementById('agentMetadata').textContent = `ID: ${agent.id} | provider: ${(agent.provider || 'openai').toUpperCase()} | model: ${agent.model}`;

                document.getElementById('editorArea').classList.remove('hidden');
                document.getElementById('settingsArea').classList.remove('hidden');
                document.getElementById('emptyArea').classList.add('hidden');
                renderAgentList();
            } catch (err) {
                showStatus('ERROR AL CARGAR AGENTE', 'error');
            }
        }

        function createNewAgent() {
            currentAgentId = null;
            document.getElementById('agentName').value = 'Nuevo Agente';
            editor.setValue('');
            document.getElementById('greeting').value = 'Hola, ¿en qué puedo ayudarte?';
            document.getElementById('provider').value = 'openai';
            updateProviderUI();
            document.getElementById('model').value = 'gpt-4.1-mini';
            document.getElementById('temperature').value = 0.8;
            document.getElementById('maxTokens').value = 400;
            document.getElementById('reminderText').value = '';
            document.getElementById('language').value = 'Spanish';
            document.getElementById('openaiApiKey').value = '';
            document.getElementById('anthropicApiKey').value = '';
            document.getElementById('deepseekApiKey').value = '';
            document.getElementById('retellApiKey').value = '';

            document.getElementById('retellUrl').value = 'Guarda para generar URL';
            document.getElementById('agentMetadata').textContent = '';

            document.getElementById('editorArea').classList.remove('hidden');
            document.getElementById('settingsArea').classList.remove('hidden');
            document.getElementById('emptyArea').classList.add('hidden');
            renderAgentList();
        }

        async function saveAgent() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'GUARDANDO...';

            const agent = {
                id: currentAgentId,
                name: document.getElementById('agentName').value,
                system_prompt: editor.getValue(),
                greeting: document.getElementById('greeting').value,
                provider: document.getElementById('provider').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('maxTokens').value),
                reminder_text: document.getElementById('reminderText').value,
                language: document.getElementById('language').value,
                openai_api_key: document.getElementById('provider').value === 'openai' ? document.getElementById('openaiApiKey').value : (document.getElementById('provider').value === 'deepseek' ? document.getElementById('deepseekApiKey').value : ''),
                anthropic_api_key: document.getElementById('provider').value === 'anthropic' ? document.getElementById('anthropicApiKey').value : '',
                retell_api_key: document.getElementById('retellApiKey').value,
            };

            try {
                const res = await fetch('/api/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agent)
                });

                const savedAgent = await res.json();
                currentAgentId = savedAgent.id;
                showStatus('CAMBIOS GUARDADOS', 'success');
                loadAgentList();
                loadAgent(currentAgentId);
            } catch (err) {
                showStatus('ERROR AL GUARDAR', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'GUARDAR CAMBIOS';
            }
        }

        async function deleteAgent() {
            if (!confirm('¿Seguro que quieres eliminar este agente?')) return;
            try {
                await fetch(`/api/agents/${currentAgentId}`, { method: 'DELETE' });
                currentAgentId = null;
                document.getElementById('editorArea').classList.add('hidden');
                document.getElementById('settingsArea').classList.add('hidden');
                document.getElementById('emptyArea').classList.remove('hidden');
                loadAgentList();
                showStatus('AGENTE ELIMINADO', 'success');
            } catch (err) {
                showStatus('ERROR AL ELIMINAR', 'error');
            }
        }

        function copyUrl() {
            const copyText = document.getElementById("retellUrl");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            showStatus('URL COPIADA', 'success');
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status ' + type;
            setTimeout(() => {
                el.textContent = '';
                el.className = 'status';
            }, 3000);
        }

        document.getElementById('saveBtn').addEventListener('click', saveAgent);

        const modelsByProvider = {
            openai: [
                { val: 'gpt-4.1-mini', label: 'gpt-4.1-mini (Nuevo/Eficaz)' },
                { val: 'gpt-4.1', label: 'gpt-4.1 (Potente)' },
                { val: 'gpt-4o-mini', label: 'gpt-4o-mini (Estable)' },
                { val: 'gpt-4o', label: 'gpt-4o (Legacy Pro)' },
                { val: 'o3-mini', label: 'o3-mini' }
            ],
            anthropic: [
                { val: 'claude-3-5-haiku-latest', label: 'Claude 3.5 Haiku (Rápido)' },
                { val: 'claude-3-5-sonnet-latest', label: 'Claude 3.5 Sonnet (Inteligente)' },
                { val: 'claude-3-7-sonnet-latest', label: 'Claude 3.7 Sonnet (Último)' }
            ],
            deepseek: [
                { val: 'deepseek-chat', label: 'DeepSeek V3 (Económico)' },
                { val: 'deepseek-reasoner', label: 'DeepSeek R1 (Razonamiento)' }
            ]
        };

        function updateProviderUI() {
            const provider = document.getElementById('provider').value;

            // Show/hide relevant key fields
            document.getElementById('openaiKeyField').classList.toggle('hidden', provider !== 'openai');
            document.getElementById('anthropicKeyField').classList.toggle('hidden', provider !== 'anthropic');
            document.getElementById('deepseekKeyField').classList.toggle('hidden', provider !== 'deepseek');

            // Update model list
            const modelSelect = document.getElementById('model');
            const models = modelsByProvider[provider] || [];
            modelSelect.innerHTML = models.map(m => `<option value="${m.val}">${m.label}</option>`).join('');
        }
        document.getElementById('newAgentBtn').addEventListener('click', createNewAgent);
        document.getElementById('deleteBtn').addEventListener('click', deleteAgent);
    </script>
</body>

</html>