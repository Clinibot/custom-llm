<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA al Teléfono | Constructor de Agentes</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/neo.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/markdown/markdown.min.js"></script>
</head>

<body>
    <div class="layout">
        <!-- Sidebar - Agent List -->
        <aside>
            <div class="sidebar-header">
                <div class="brand">IA AL TELÉFONO</div>
                <div class="agent-list-header">
                    <span>Mis Agentes</span>
                    <button id="newAgentBtn" class="btn-icon" title="Nuevo Agente">+</button>
                </div>
            </div>
            <nav id="agentList">
                <div class="status">Cargando agentes...</div>
            </nav>
            <div class="sidebar-footer">
                <button id="saveBtn">GUARDAR CAMBIOS</button>
                <div id="status" class="status"></div>
            </div>
        </aside>

        <!-- Main Editor (Prompt) -->
        <main id="editorArea" class="editor-pane hidden">
            <header class="agent-header">
                <div class="section-label">Nombre del Agente</div>
                <input type="text" id="agentName" class="input-large" placeholder="Escribe un nombre...">
                <div id="agentMetadata" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"></div>
            </header>

            <section>
                <div class="section-label">System Prompt</div>
                <div class="editor-container">
                    <textarea id="systemPrompt"></textarea>
                </div>
            </section>

            <section>
                <div class="section-label">Saludo Inicial</div>
                <input type="text" id="greeting" placeholder="Hola, ¿cómo puedo ayudarte?">
            </section>
        </main>

        <!-- Settings Pane (Right) -->
        <div id="settingsArea" class="settings-pane hidden">
            <!-- Knowledge Base -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('kb-content', this)">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <h3>Brain & RAG</h3>
                        <div class="info-trigger" onclick="event.stopPropagation(); showRagHelp()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="16" x2="12" y2="12" />
                                <line x1="12" y1="8" x2="12.01" y2="8" />
                            </svg>
                        </div>
                    </div>
                    <svg class="chevron rotated" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="kb-content" class="card-content accordion-content active">
                    <div class="field">
                        <label>ID Base de Conocimientos</label>
                        <input type="text" id="knowledgeBase" placeholder="ID de Supabase">
                    </div>
                </div>
            </div>

            <!-- Call Settings -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('call-settings-content', this)">
                    <h3>Call Settings</h3>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="call-settings-content" class="card-content accordion-content">
                    <div class="field">
                        <label>End Call on Silence (ms)</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="endCallSilence" value="600000" step="1000">
                            <span class="unit-label">ms</span>
                        </div>
                        <p class="field-desc">Termina si el usuario calla por este tiempo (Def: 10 min)</p>
                    </div>
                    <div class="field">
                        <label>Max Call Duration (ms)</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="maxCallDuration" value="3600000" step="1000">
                            <span class="unit-label">ms</span>
                        </div>
                        <p class="field-desc">Duración máxima de llamada (Def: 1 h)</p>
                    </div>
                    <div class="field">
                        <label>Ring Duration (s)</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="ringDuration" value="30" min="5" max="90">
                            <span class="unit-label">s</span>
                        </div>
                        <p class="field-desc">Tiempo máx. de timbrado (5s - 90s)</p>
                    </div>
                </div>
            </div>

            <!-- Data Extraction -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('extraction-content', this)">
                    <h3>Post-Call Data Extraction</h3>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="extraction-content" class="card-content accordion-content">
                    <div class="field">
                        <label>Campos a Recuperar</label>
                        <textarea id="extractionFields" placeholder="nombre, servicio, email"
                            style="height: 60px;"></textarea>
                        <p class="field-desc">Define qué información debe extraer la IA de la voz.</p>
                    </div>
                </div>
            </div>

            <!-- Automation -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('auto-content', this)">
                    <h3>Automatización</h3>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="auto-content" class="card-content accordion-content">
                    <div class="field">
                        <label>Frases de cierre (cuelga)</label>
                        <input type="text" id="hangupPhrases" placeholder="adiós, hasta luego">
                    </div>
                    <div class="field">
                        <label>Webhook Estadísticas (Make/n8n)</label>
                        <input type="text" id="webhookUrl" placeholder="https://hook.make.com/...">
                        <p class="field-desc">Solo recibe evento 'call_analyzed'</p>
                    </div>
                </div>
            </div>

            <!-- Integration -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('retell-content', this)">
                    <h3>Retell AI Integration</h3>
                    <svg class="chevron rotated" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="retell-content" class="card-content accordion-content active">
                    <div class="field">
                        <label>Custom LLM URL</label>
                        <div class="url-copy-wrapper">
                            <input type="text" id="retellUrl" readonly>
                            <button class="btn-secondary" onclick="copyUrl()">COPIAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Parameters -->
            <div class="card">
                <div class="card-header" onclick="toggleAccordion('model-content', this)">
                    <h3>Modelo y Parámetros</h3>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div id="model-content" class="card-content accordion-content">
                    <div class="row">
                        <div class="field">
                            <label>Modelo</label>
                            <select id="model">
                                <option value="gpt-4o-mini">gpt-4.1-mini (Recomendado)</option>
                                <option value="gpt-4o">gpt-4.1 (Pro)</option>
                                <option value="o3-mini">o3-mini</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Idioma</label>
                            <select id="language">
                                <option value="Spanish">Español</option>
                                <option value="English">Inglés</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Temp</label>
                            <input type="number" id="temperature" step="0.1" value="0.8">
                        </div>
                        <div class="field">
                            <label>Max Tokens</label>
                            <input type="number" id="maxTokens" value="400">
                        </div>
                    </div>
                    <div class="field">
                        <label>Texto recordatorio (silencio)</label>
                        <input type="text" id="reminderText">
                    </div>
                </div>
            </div>

            <button class="btn-danger" id="deleteBtn">ELIMINAR AGENTE</button>
        </div>

        <!-- Empty State -->
        <main id="emptyArea" class="empty-pane">
            <div class="brand" style="font-size: 3.5rem; margin-bottom: 2rem;">IA AL TELÉFONO</div>
            <p style="color: var(--text-muted); margin-bottom: 32px; font-size: 1.1rem;">Selecciona un agente de la
                lista o crea uno nuevo para empezar.</p>
            <button onclick="createNewAgent()"
                style="width: auto; padding: 14px 28px; background: var(--electric-gradient); color: white; border: none; font-weight: 600;">+
                CREAR NUEVO AGENTE</button>
        </main>
    </div>

    <!-- RAG Help Modal -->
    <div id="ragModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2>Cerebro IA (RAG) - Guía de Configuración</h2>
                <button class="btn-icon" onclick="hideRagHelp()">×</button>
            </div>
            <div class="modal-body">
                <p>El RAG permite que tu agente responda usando tu propia base de conocimientos técnica o comercial.</p>

                <div class="step-guide">
                    <div class="step">
                        <div class="step-num">1</div>
                        <div class="step-text">Define un <strong>ID de Base de Conocimientos</strong> en este panel (ej:
                            <code>clinica_1</code>).
                        </div>
                    </div>
                    <div class="arrow">↓</div>
                    <div class="step">
                        <div class="step-num">2</div>
                        <div class="step-text">Ejecuta este código en el <strong>SQL Editor</strong> de Supabase:</div>
                    </div>
                </div>

                <div class="code-block-header">
                    <span>SQL de Configuración</span>
                    <button class="btn-secondary btn-small" onclick="copySql()">COPIAR SQL</button>
                </div>
                <pre id="ragSql" class="sql-preview">
-- 1. Tabla de Documentos
CREATE TABLE IF NOT EXISTS documents (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  content text, 
  kb_id text, 
  embedding vector(1536)
);

-- 2. Función de Búsqueda
CREATE OR REPLACE FUNCTION match_documents (
  query_embedding vector(1536),
  match_threshold float,
  match_count int,
  filter_kb_id text
)
RETURNS TABLE (id uuid, content text, similarity float)
LANGUAGE plpgsql AS $$
BEGIN
  RETURN QUERY
  SELECT documents.id, documents.content,
         1 - (documents.embedding <=> query_embedding) AS similarity
  FROM documents
  WHERE 1 - (documents.embedding <=> query_embedding) > match_threshold
    AND documents.kb_id = filter_kb_id
  ORDER BY similarity DESC LIMIT match_count;
END;
$$;</pre>

                <div class="step-guide" style="margin-top: 20px;">
                    <div class="step">
                        <div class="step-num">3</div>
                        <div class="step-text">Sube tus textos a la tabla <code>documents</code> asegurándote de que el
                            campo <code>kb_id</code> coincida con el que pusiste en el paso 1.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="hideRagHelp()" style="width: 100%;">ENTENDIDO</button>
            </div>
        </div>
    </div>

    <script>
        let editor;
        let currentAgentId = null;
        let agents = [];

        window.addEventListener('DOMContentLoaded', () => {
            editor = CodeMirror.fromTextArea(document.getElementById('systemPrompt'), {
                mode: 'markdown',
                theme: 'neo',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: Infinity
            });
            loadAgentList();
        });

        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            const chevron = header.querySelector('.chevron');
            if (content.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => { content.classList.remove('active'); content.style.maxHeight = '0'; }, 10);
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('active');
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => { content.style.maxHeight = 'none'; }, 300);
                chevron.classList.add('rotated');
            }
        }

        async function loadAgentList() {
            try {
                const res = await fetch('/api/agents');
                agents = await res.json();
                renderAgentList();
            } catch (err) {
                showStatus('ERROR AL CARGAR LISTA', 'error');
            }
        }

        function renderAgentList() {
            const list = document.getElementById('agentList');
            list.innerHTML = '';
            if (agents.length === 0) {
                list.innerHTML = '<div class="status">No hay agentes.</div>';
                return;
            }
            agents.forEach(agent => {
                const div = document.createElement('div');
                div.className = `nav-item ${currentAgentId === agent.id ? 'active' : ''}`;
                div.textContent = agent.name;
                div.onclick = () => loadAgent(agent.id);
                list.appendChild(div);
            });
        }

        async function loadAgent(id) {
            currentAgentId = id;
            try {
                const res = await fetch(`/api/agents/${id}`);
                const agent = await res.json();

                document.getElementById('agentName').value = agent.name;
                editor.setValue(agent.system_prompt || '');
                document.getElementById('greeting').value = agent.greeting || '';
                document.getElementById('model').value = agent.model || 'gpt-4o-mini';
                document.getElementById('temperature').value = agent.temperature ?? 0.8;
                document.getElementById('maxTokens').value = agent.max_tokens || 400;
                document.getElementById('reminderText').value = agent.reminder_text || '';
                document.getElementById('knowledgeBase').value = agent.knowledge_base || '';
                document.getElementById('webhookUrl').value = agent.webhook_url || '';
                document.getElementById('hangupPhrases').value = agent.hangup_phrases || '';
                document.getElementById('extractionFields').value = agent.extraction_fields || '';
                document.getElementById('language').value = agent.language || 'Spanish';

                // Advanced Call Settings
                document.getElementById('endCallSilence').value = agent.end_call_silence_ms || 600000;
                document.getElementById('maxCallDuration').value = agent.max_call_duration_ms || 3600000;
                document.getElementById('ringDuration').value = agent.ring_duration_s || 30;

                const wsBase = window.location.origin.replace('http', 'ws');
                document.getElementById('retellUrl').value = `${wsBase}/llm-websocket/${agent.id}/{call_id}`;

                document.getElementById('agentMetadata').textContent = `ID: ${agent.id} | model: ${agent.model}`;

                document.getElementById('editorArea').classList.remove('hidden');
                document.getElementById('settingsArea').classList.remove('hidden');
                document.getElementById('emptyArea').classList.add('hidden');
                renderAgentList();
            } catch (err) {
                showStatus('ERROR AL CARGAR AGENTE', 'error');
            }
        }

        function createNewAgent() {
            currentAgentId = null;
            document.getElementById('agentName').value = 'Nuevo Agente';
            editor.setValue('');
            document.getElementById('greeting').value = 'Hola, ¿en qué puedo ayudarte?';
            document.getElementById('model').value = 'gpt-4o-mini';
            document.getElementById('temperature').value = 0.8;
            document.getElementById('maxTokens').value = 400;
            document.getElementById('reminderText').value = '';
            document.getElementById('knowledgeBase').value = '';
            document.getElementById('webhookUrl').value = '';
            document.getElementById('hangupPhrases').value = '';
            document.getElementById('extractionFields').value = '';
            document.getElementById('language').value = 'Spanish';
            document.getElementById('endCallSilence').value = 600000;
            document.getElementById('maxCallDuration').value = 3600000;
            document.getElementById('ringDuration').value = 30;

            document.getElementById('retellUrl').value = 'Guarda para generar URL';
            document.getElementById('agentMetadata').textContent = '';

            document.getElementById('editorArea').classList.remove('hidden');
            document.getElementById('settingsArea').classList.remove('hidden');
            document.getElementById('emptyArea').classList.add('hidden');
            renderAgentList();
        }

        async function saveAgent() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'GUARDANDO...';

            const agent = {
                id: currentAgentId,
                name: document.getElementById('agentName').value,
                system_prompt: editor.getValue(),
                greeting: document.getElementById('greeting').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('maxTokens').value),
                reminder_text: document.getElementById('reminderText').value,
                knowledge_base: document.getElementById('knowledgeBase').value,
                webhook_url: document.getElementById('webhookUrl').value,
                hangup_phrases: document.getElementById('hangupPhrases').value,
                extraction_fields: document.getElementById('extractionFields').value,
                language: document.getElementById('language').value,
                // Advanced Call Settings
                end_call_silence_ms: parseInt(document.getElementById('endCallSilence').value),
                max_call_duration_ms: parseInt(document.getElementById('maxCallDuration').value),
                ring_duration_s: parseInt(document.getElementById('ringDuration').value)
            };

            try {
                const res = await fetch('/api/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agent)
                });

                const savedAgent = await res.json();
                currentAgentId = savedAgent.id;
                showStatus('CAMBIOS GUARDADOS', 'success');
                loadAgentList();
                loadAgent(currentAgentId);
            } catch (err) {
                showStatus('ERROR AL GUARDAR', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'GUARDAR CAMBIOS';
            }
        }

        async function deleteAgent() {
            if (!confirm('¿Seguro que quieres eliminar este agente?')) return;
            try {
                await fetch(`/api/agents/${currentAgentId}`, { method: 'DELETE' });
                currentAgentId = null;
                document.getElementById('editorArea').classList.add('hidden');
                document.getElementById('settingsArea').classList.add('hidden');
                document.getElementById('emptyArea').classList.remove('hidden');
                loadAgentList();
                showStatus('AGENTE ELIMINADO', 'success');
            } catch (err) {
                showStatus('ERROR AL ELIMINAR', 'error');
            }
        }

        function copyUrl() {
            const copyText = document.getElementById("retellUrl");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            showStatus('URL COPIADA', 'success');
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status ' + type;
            setTimeout(() => {
                el.textContent = '';
                el.className = 'status';
            }, 3000);
        }

        function showRagHelp() {
            document.getElementById('ragModal').classList.remove('hidden');
        }

        function hideRagHelp() {
            document.getElementById('ragModal').classList.add('hidden');
        }

        function copySql() {
            const sqlText = document.getElementById("ragSql").innerText;
            navigator.clipboard.writeText(sqlText);
            showStatus('SQL COPIADO', 'success');
        }

        document.getElementById('saveBtn').addEventListener('click', saveAgent);
        document.getElementById('newAgentBtn').addEventListener('click', createNewAgent);
        document.getElementById('deleteBtn').addEventListener('click', deleteAgent);
    </script>
</body>

</html>